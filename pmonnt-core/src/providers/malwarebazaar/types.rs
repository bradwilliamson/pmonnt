use std::io;

#[derive(Debug, Clone, serde::Deserialize)]
pub struct MbSampleInfo {
    #[serde(rename = "sha256_hash")]
    pub sha256: String,
    pub signature: Option<String>,
    pub tags: Vec<String>,
    pub first_seen: Option<String>,
    pub last_seen: Option<String>,
    pub file_name: Option<String>,
    pub file_type_mime: Option<String>,
    pub file_size: Option<u64>,
    pub vendor_intel: Option<serde_json::Value>,
    pub yara_rules: Option<serde_json::Value>,
    pub comments: Option<Vec<MbComment>>,
}

#[derive(Debug, Clone, serde::Deserialize)]
pub struct MbComment {
    pub date: Option<String>,
    pub comment: Option<String>,
    pub author: Option<String>,
}

#[derive(Debug)]
pub struct MbDownloadResult {
    pub file_path: std::path::PathBuf,
    pub file_size: u64,
}

#[derive(Debug, Clone, serde::Deserialize)]
pub struct MbRecentDetection {
    pub sha256_hash: String,
    pub signature: Option<String>,
    pub tags: Option<Vec<String>>,
    pub first_seen: Option<String>,
    pub last_seen: Option<String>,
    pub file_name: Option<String>,
    pub file_type_mime: Option<String>,
    pub file_size: Option<u64>,
    pub reporter: Option<String>,
    pub origin_country: Option<String>,
    pub anonymous: Option<i32>,
    pub delivery_method: Option<String>,
    pub comment: Option<String>,
}

#[derive(Debug, Clone, serde::Deserialize)]
pub struct MbTagInfoSample {
    pub sha256_hash: String,
    pub signature: Option<String>,
    pub tags: Option<Vec<String>>,
    pub first_seen: Option<String>,
    pub last_seen: Option<String>,
    pub file_name: Option<String>,
    pub file_type_mime: Option<String>,
    pub file_size: Option<u64>,
}

/// Recent additions sample (get_recent)
#[derive(Debug, Clone)]
pub struct MbRecentSample {
    pub sha256: String,
    pub file_name: Option<String>,
    pub signature: Option<String>,
    pub first_seen: Option<String>,
    pub file_type_mime: Option<String>,
    pub tags: Vec<String>,
}

/// Code Signing Certificate Blocklist entry (get_cscb)
#[derive(Debug, Clone)]
pub struct MbCscbEntry {
    pub time_stamp: String,
    pub serial_number: String,
    pub thumbprint: String,
    pub subject_cn: String,
    pub issuer_cn: String,
    pub valid_from: String,
    pub valid_to: String,
    pub cscb_listed: bool,
    pub cscb_reason: String,
}

/// Metadata about the last MalwareBazaar query
#[derive(Debug, Clone)]
pub struct MbQueryMeta {
    pub last_query: Option<String>,
    pub last_http_status: Option<u16>,
    pub last_query_status: Option<String>,
    pub last_result_count: Option<usize>,
    pub last_error_message: Option<String>,
}

#[derive(Debug, thiserror::Error)]
pub enum MbApiError {
    #[error("File not found")]
    FileNotFound,
    #[error("Illegal SHA256 hash")]
    IllegalSha256Hash,
    #[error("No SHA256 hash provided")]
    NoSha256Hash,
    #[error("Network error: {0}")]
    Network(#[from] reqwest::Error),
    #[error("IO error: {0}")]
    Io(#[from] io::Error),
    #[error("File too large (max 100MB)")]
    FileTooLarge,
    #[error("Rate limited")]
    RateLimited,
    #[error("Not configured")]
    NotConfigured,
    #[error("Illegal hours value")]
    IllegalHours,
    #[error("Illegal tag")]
    IllegalTag,
    #[error("HTTP {0}")]
    Http(u16),
}
