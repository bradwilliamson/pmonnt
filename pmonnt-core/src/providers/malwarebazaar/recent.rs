use super::{MalwareBazaarProvider, MbApiError, MbQueryMeta, MbRecentSample};

use log::{debug, warn};
use std::time::Duration;

impl MalwareBazaarProvider {
    /// Get recent additions (selector = "time" for last 60 minutes or "100" for latest 100)
    pub fn get_recent(&self, selector: &str) -> Result<Vec<MbRecentSample>, MbApiError> {
        let mut meta = MbQueryMeta {
            last_query: Some("get_recent".to_string()),
            last_http_status: None,
            last_query_status: None,
            last_result_count: None,
            last_error_message: None,
        };

        let api_key = self
            .api_key
            .lock()
            .map_err(|_| MbApiError::NotConfigured)?
            .clone()
            .ok_or(MbApiError::NotConfigured)?;
        if self.is_rate_limited() {
            return Err(MbApiError::RateLimited);
        }

        let client = reqwest::blocking::Client::builder()
            .timeout(Duration::from_secs(30))
            .build()?;

        let form = [("query", "get_recent"), ("selector", selector)];
        let response = client
            .post(Self::api_base_url())
            .header("Auth-Key", api_key)
            .form(&form)
            .send()?;

        let status = response.status();
        meta.last_http_status = Some(status.as_u16());
        debug!(
            "MalwareBazaar get_recent HTTP {} selector={}",
            status.as_u16(),
            selector
        );

        if status == 401 || status == 403 {
            let body = response.text().unwrap_or_default();
            warn!(
                "MalwareBazaar get_recent unauthorized ({}). body: {}",
                status.as_u16(),
                body.chars().take(1024).collect::<String>()
            );
            meta.last_error_message = Some("unauthorized".to_string());
            self.set_last_query_meta(meta);
            return Err(MbApiError::NotConfigured);
        }
        if status == 429 {
            let body = response.text().unwrap_or_default();
            warn!(
                "MalwareBazaar get_recent rate limited ({}). body: {}",
                status.as_u16(),
                body.chars().take(1024).collect::<String>()
            );
            self.set_rate_limited();
            meta.last_error_message = Some("rate_limited".to_string());
            self.set_last_query_meta(meta);
            return Err(MbApiError::RateLimited);
        }
        if !status.is_success() {
            let body = response.text().unwrap_or_default();
            warn!(
                "MalwareBazaar get_recent HTTP {}. body: {}",
                status.as_u16(),
                body.chars().take(1024).collect::<String>()
            );
            meta.last_error_message = Some(format!("http_{}", status.as_u16()));
            self.set_last_query_meta(meta);
            return Err(MbApiError::Http(status.as_u16()));
        }

        let json: serde_json::Value = response.json()?;
        let query_status = json
            .get("query_status")
            .and_then(|v| v.as_str())
            .unwrap_or("");
        meta.last_query_status = Some(query_status.to_string());

        match query_status {
            "ok" => {}
            "no_selector" | "unknown_selector" | "no_results" => {
                meta.last_result_count = Some(0);
                self.set_last_query_meta(meta);
                return Ok(Vec::new());
            }
            other => {
                meta.last_error_message = Some(format!("unexpected: {}", other));
                self.set_last_query_meta(meta);
                return Err(MbApiError::Http(400));
            }
        }

        let empty_vec = Vec::new();
        let data = json
            .get("data")
            .and_then(|v| v.as_array())
            .unwrap_or(&empty_vec);
        let mut out = Vec::new();
        for item in data.iter() {
            let sha = item
                .get("sha256_hash")
                .or_else(|| item.get("sha256"))
                .and_then(|v| v.as_str())
                .unwrap_or("")
                .to_string();
            let file_name = item
                .get("file_name")
                .and_then(|v| v.as_str())
                .map(|s| s.to_string());
            let signature = item
                .get("signature")
                .and_then(|v| v.as_str())
                .map(|s| s.to_string());
            let first_seen = item
                .get("first_seen")
                .and_then(|v| v.as_str())
                .map(|s| s.to_string());
            let file_type_mime = item
                .get("file_type_mime")
                .and_then(|v| v.as_str())
                .map(|s| s.to_string());
            let tags = item
                .get("tags")
                .and_then(|v| v.as_array())
                .map(|arr| {
                    arr.iter()
                        .filter_map(|x| x.as_str().map(|s| s.to_string()))
                        .collect()
                })
                .unwrap_or_else(Vec::new);
            out.push(MbRecentSample {
                sha256: sha,
                file_name,
                signature,
                first_seen,
                file_type_mime,
                tags,
            });
        }
        meta.last_result_count = Some(out.len());
        self.set_last_query_meta(meta);
        Ok(out)
    }
}
