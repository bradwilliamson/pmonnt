use super::{MalwareBazaarProvider, MbApiError, MbQueryMeta, MbSampleInfo};

use log::{debug, warn};
use std::io;
use std::time::Duration;

impl MalwareBazaarProvider {
    /// Get info for a hash and return sample (if any) plus meta
    pub fn get_info_verbose(
        &self,
        sha256: &str,
    ) -> Result<(Option<MbSampleInfo>, MbQueryMeta), MbApiError> {
        let mut meta = MbQueryMeta {
            last_query: Some("get_info".to_string()),
            last_http_status: None,
            last_query_status: None,
            last_result_count: None,
            last_error_message: None,
        };

        // Get API key
        let api_key = self
            .api_key
            .lock()
            .map_err(|_| MbApiError::NotConfigured)?
            .clone()
            .ok_or(MbApiError::NotConfigured)?;

        if self.is_rate_limited() {
            meta.last_error_message = Some("rate_limited".to_string());
            self.set_last_query_meta(meta.clone());
            return Err(MbApiError::RateLimited);
        }

        let client = reqwest::blocking::Client::builder()
            .timeout(Duration::from_secs(10))
            .build()?;
        let form = [("query", "get_info"), ("hash", sha256)];
        let resp = client
            .post(Self::api_base_url())
            .header("Auth-Key", api_key)
            .form(&form)
            .send()?;
        let status = resp.status();
        meta.last_http_status = Some(status.as_u16());
        debug!(
            "MalwareBazaar get_info HTTP {} for {}",
            status.as_u16(),
            sha256
        );

        if status == 401 || status == 403 {
            let body = resp.text().unwrap_or_default();
            warn!(
                "MalwareBazaar get_info unauthorized ({}). body: {}",
                status.as_u16(),
                body.chars().take(1024).collect::<String>()
            );
            meta.last_error_message = Some("unauthorized".to_string());
            self.set_last_query_meta(meta.clone());
            return Err(MbApiError::NotConfigured);
        }

        if status == 429 {
            let body = resp.text().unwrap_or_default();
            warn!(
                "MalwareBazaar get_info rate limited ({}). body: {}",
                status.as_u16(),
                body.chars().take(1024).collect::<String>()
            );
            self.set_rate_limited();
            meta.last_error_message = Some("rate_limited".to_string());
            self.set_last_query_meta(meta.clone());
            return Err(MbApiError::RateLimited);
        }

        if !status.is_success() {
            let body = resp.text().unwrap_or_default();
            warn!(
                "MalwareBazaar get_info HTTP {}. body: {}",
                status.as_u16(),
                body.chars().take(1024).collect::<String>()
            );
            meta.last_error_message = Some(format!("http_{}", status.as_u16()));
            self.set_last_query_meta(meta.clone());
            return Err(MbApiError::Http(status.as_u16()));
        }

        let json: serde_json::Value = resp.json()?;
        let query_status = json
            .get("query_status")
            .and_then(|v| v.as_str())
            .unwrap_or("")
            .to_string();
        meta.last_query_status = Some(query_status.clone());

        match query_status.as_str() {
            "hash_not_found" => {
                // clear last sample
                if let Ok(mut guard) = self.last_sample.lock() {
                    *guard = None;
                }
                self.set_last_query_meta(meta.clone());
                return Ok((None, meta));
            }
            s if s.starts_with("illegal_") || s == "no_hash_provided" => {
                meta.last_error_message = Some(s.to_string());
                self.set_last_query_meta(meta.clone());
                return Err(MbApiError::Http(400));
            }
            "ok" => {}
            other => {
                meta.last_error_message = Some(format!("unexpected: {}", other));
                self.set_last_query_meta(meta.clone());
                return Err(MbApiError::Http(400));
            }
        }

        let data = json
            .get("data")
            .and_then(|v| v.as_array())
            .and_then(|arr| arr.first());
        if let Some(d) = data {
            let sample: MbSampleInfo = serde_json::from_value(d.clone())
                .map_err(|e| MbApiError::Io(io::Error::other(format!("parse: {}", e))))?;
            meta.last_result_count = Some(1);
            // cache last sample for UI
            if let Ok(mut guard) = self.last_sample.lock() {
                *guard = Some(sample.clone());
            }
            self.set_last_query_meta(meta.clone());
            Ok((Some(sample), meta))
        } else {
            meta.last_result_count = Some(0);
            if let Ok(mut guard) = self.last_sample.lock() {
                *guard = None;
            }
            self.set_last_query_meta(meta.clone());
            Ok((None, meta))
        }
    }
}
