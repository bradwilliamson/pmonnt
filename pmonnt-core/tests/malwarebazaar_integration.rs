use pmonnt_core::local_cache::LocalCacheProvider;
use pmonnt_core::providers::MalwareBazaarProvider;
use pmonnt_core::reputation::LookupState;
use pmonnt_core::reputation::ReputationProvider;
use std::sync::Arc;

#[test]
fn mb_provider_without_api_key_returns_not_configured() {
    let unique = std::time::SystemTime::now()
        .duration_since(std::time::UNIX_EPOCH)
        .unwrap_or_default()
        .as_nanos();
    let cache = Arc::new(LocalCacheProvider::new(std::env::temp_dir().join(format!(
        "pmonnt_test_cache_{}_{}.json",
        std::process::id(),
        unique
    ))));
    // Create provider with no API key explicitly (provider will also check env)
    let provider = MalwareBazaarProvider::new(cache.clone(), None);
    // Force-disable any env-provided key so the test is deterministic and never performs network I/O.
    provider.update_api_key(None);

    // When no API key is provided, provider methods should return an error or NotConfigured
    // Call `lookup_hash` with a dummy hash and assert it doesn't panic and returns a LookupState
    let state =
        provider.lookup_hash("0000000000000000000000000000000000000000000000000000000000000000");
    // Accept either NotConfigured, Disabled, or Error as valid behavior for missing key.
    assert!(matches!(state, LookupState::NotConfigured));
}

#[test]
fn mb_provider_with_env_var_constructs() {
    let unique = std::time::SystemTime::now()
        .duration_since(std::time::UNIX_EPOCH)
        .unwrap_or_default()
        .as_nanos();
    // Test constructing provider when env var present (we don't perform network calls here)
    let cache = Arc::new(LocalCacheProvider::new(std::env::temp_dir().join(format!(
        "pmonnt_test_cache2_{}_{}.json",
        std::process::id(),
        unique
    ))));
    // Read key from `PMONNT_MB_API_KEY` (primary) with fallback for backward compatibility
    let api_key = std::env::var("PMONNT_MB_API_KEY")
        .ok()
        .or_else(|| std::env::var("PMONNT_MALWAREBAZAAR_KEY").ok());
    let provider = MalwareBazaarProvider::new(cache.clone(), api_key.clone());

    // Ensure provider constructed and name is available
    assert_eq!(provider.name(), "MB");

    // IMPORTANT: Do not perform real network I/O during default test runs.
    // Opt-in only: set `PMONNT_RUN_INTEGRATION_TESTS=1` to allow hitting the live API.
    let run_integration = std::env::var("PMONNT_RUN_INTEGRATION_TESTS")
        .map(|v| v == "1")
        .unwrap_or(false);
    if run_integration && api_key.is_some() {
        // Not asserting on the result: this is a smoke call for local/dev use.
        let _ = provider.recent_detections(None);
    }
}
