//! Tests for MalwareBazaar provider behavior

use pmonnt_core::providers::MalwareBazaarProvider;
use pmonnt_core::local_cache::LocalCacheProvider;
use std::sync::Arc;
use tempfile::tempdir;

#[test]
fn test_provider_construction_with_api_key() {
    let temp = tempdir().unwrap();
    let cache = Arc::new(LocalCacheProvider::new(temp.path().join("cache.json")));
    let provider = MalwareBazaarProvider::new(cache, Some("test_api_key".to_string()));
    
    // Provider should be constructed successfully
    assert!(provider.get_last_query_meta().is_none());
}

#[test]
fn test_provider_construction_without_api_key() {
    let temp = tempdir().unwrap();
    let cache = Arc::new(LocalCacheProvider::new(temp.path().join("cache.json")));
    let _provider = MalwareBazaarProvider::new(cache, None);
    
    // Should construct without panic
}

#[test]
fn test_api_key_management() {
    let temp = tempdir().unwrap();
    let cache = Arc::new(LocalCacheProvider::new(temp.path().join("cache.json")));
    let provider = MalwareBazaarProvider::new(cache, Some("initial_key".to_string()));
    
    // Update key
    provider.update_api_key(Some("new_key".to_string()));
    
    // Clear key
    provider.update_api_key(None);
}

#[test]
fn test_last_query_meta_initially_none() {
    let temp = tempdir().unwrap();
    let cache = Arc::new(LocalCacheProvider::new(temp.path().join("cache.json")));
    let provider = MalwareBazaarProvider::new(cache, None);
    
    assert!(provider.get_last_query_meta().is_none());
}

#[test]
fn test_last_sample_initially_none() {
    let temp = tempdir().unwrap();
    let cache = Arc::new(LocalCacheProvider::new(temp.path().join("cache.json")));
    let provider = MalwareBazaarProvider::new(cache, None);
    
    assert!(provider.get_last_sample().is_none());
}

#[test]
fn test_multiple_providers_share_cache() {
    let temp = tempdir().unwrap();
    let cache = Arc::new(LocalCacheProvider::new(temp.path().join("cache.json")));
    
    let provider1 = MalwareBazaarProvider::new(Arc::clone(&cache), Some("key1".to_string()));
    let provider2 = MalwareBazaarProvider::new(Arc::clone(&cache), Some("key2".to_string()));
    
    // Both should be constructed successfully
    let _ = provider1.get_last_query_meta();
    let _ = provider2.get_last_query_meta();
}

#[test]
fn test_provider_with_empty_cache_path() {
    let temp = tempdir().unwrap();
    let cache = Arc::new(LocalCacheProvider::new(temp.path().join("test.json")));
    let provider = MalwareBazaarProvider::new(cache, Some("key".to_string()));
    
    // Should not panic with empty cache
    assert!(provider.get_last_sample().is_none());
}

#[test]
fn test_concurrent_api_key_updates() {
    let temp = tempdir().unwrap();
    let cache = Arc::new(LocalCacheProvider::new(temp.path().join("cache.json")));
    let provider = MalwareBazaarProvider::new(cache, Some("key1".to_string()));
    
    // Simulate rapid updates
    for i in 0..10 {
        provider.update_api_key(Some(format!("key_{}", i)));
    }
    
    // Should not panic or deadlock
}

#[test]
fn test_provider_clone_behavior() {
    let temp = tempdir().unwrap();
    let cache = Arc::new(LocalCacheProvider::new(temp.path().join("cache.json")));
    
    // Create two providers with same cache
    let provider1 = MalwareBazaarProvider::new(Arc::clone(&cache), Some("key1".to_string()));
    let _provider2 = MalwareBazaarProvider::new(cache, Some("key2".to_string()));
    
    // Verify provider1 still works
    assert!(provider1.get_last_query_meta().is_none());
}
